---
---
title: "Comparison_SCNA"
author: "Chiara Schiller"
date: "2023-04-17"
output: html_document
---

## Compare all tools, results saved in folder 2 up

```{r}
# Install packages
library(FactoMineR)
library(ggcorrplot)
library(corrr)
library(readr)
library(ggfortify)
library(ggplot2)
library(randomForestSRC)
library(caret)
library(tidyverse)

```

Load in all different result files
```{r}
csv_dir = "./../../results_4ct_sym_0.2grid_self/"
data <- list.files(path = csv_dir, pattern = "\\.csv$")
all = list()
data
for (i in 1:length(data)){
  all[[i]] <- as.data.frame(read_csv(paste0(csv_dir,data[i])))
  rownames(all[[i]]) = sub("4ct_self", "", as.vector(all[[i]][,1]))
  rownames(all[[i]]) = sub(".csv", "", rownames(all[[i]]))
  all[[i]] = all[[i]][,-1]
}

```
Create defining group columns within datasets
```{r}
df_list = list()

for (i in 1:length(all)){
  all[[i]]$preference <- sub("_ab.*sim_\\d+$", "", rownames(all[[i]]))
  all[[i]]$preference <- sub("self_", "self0_", all[[i]]$preference)
  all[[i]]$abundance <- sub(".*ab", "ab", rownames(all[[i]]))
  all[[i]]$abundance = sub("_sim_[0-9]+$", "", all[[i]]$abundance)
}

```

Gereate datasets with only the two groups to compare, give it the right naming and then the rest of the script should stay the same :)
 
 Naming convention: Tool_x_vs_y

```{r}
# prepare lists
df_comb = list()
split_string <- strsplit(data, "4ct")
toollist <- sub("_+$", "", split_string[[1]][1])
#part_after_sim <- paste("sim", split_string[[1]][2], sep = "")
combs <- combn(unique(all[[1]]$abundance), 2)
pref_comb <- apply(combs, 2, function(x) c(as.character(x[1]), as.character(x[2])))
# now loop through every combination of abundances are preferences to compare all tools withtin their abundances
for (i in 1:length(all)){
  
  #pref_comb <- apply(combs, 2, function(x) c(as.character(x[1]), as.character(x[2])))
  
  for (p in unique(all[[i]]$preference)){
      df = all[[i]] %>% filter(preference == p) 
    for (a in 1:ncol(pref_comb)){
      df2 = df %>% filter(abundance %in% pref_comb[,a]) 
      df_comb[[paste(sub("_+$", "", split_string[[i]][1]), unique(df2$preference), sort(unique(df2$abundance))[1], "vs", sort(unique(df2$abundance))[2], sep = "_")]] = df2 %>% select(-preference, -abundance) 
    
      #df_comb[[paste(sub("_+$", "", split_string[[i]][1]), unique(df2$abundance), paste(pref_comb[,p], sep = "_vs_"), sep = "_")]] = df2
      }
    }
}
# these are the comparisons we have:
names(df_comb)

```
### from here, filter df_comb however you want
```{r}
#names_to_keep <- grep("Giotto", names(df_comb), value = TRUE)

# filter the list based on the names
#all <- df_comb[names_to_keep]
all = df_comb
```


Create heatmap for all to see, what to expect
```{r}
library(tidyverse)
library(factoextra)
library(pheatmap)


for (i in 1:length(all)){
  pheatmap(all[[i]], treeheight_row = 0, treeheight_col = 0, main = names(all)[i])
}
#generate heatmap for all
# Misty und SEA haben noch ein self06 datenfile intus.

```
Create PCA plot of all results
```{r}
i = 1
for (i in 1:length(all)){
df = all[[i]]
pca_res <- prcomp(df, scale. = TRUE)
# compare abundances
df$group = sub(".*_ab", "ab", rownames(df))
df$group = sub("_sim_[0-9]+$", "", df$group)

print(autoplot(pca_res, data = df, colour = 'group') +
      ggtitle(names(all)[i]) +
        theme_bw()
      )
}


```
Set functions for random forest and F1 statistics
```{r}
stat = list()
# Load required packages
library(caret)
library(randomForest)
# Create an index variable for the two groups
group_index <- rep(c("A","B"), each=100)

# write F1 and FDR function
# Calculate the F1 score
F1_Score <- function(predictions, actual) {
  TP <- sum(predictions == "B" & actual == "B")
  FP <- sum(predictions == "B" & actual == "A")
  FN <- sum(predictions == "A" & actual == "B")
  precision <- TP / (TP + FP)
  recall <- TP / (TP + FN)
  F1 <- 2 * precision * recall / (precision + recall)
  FDR <- FP / (TP + FP)
  return(c(F1, FDR))
}

# Set seed for reproducibility
set.seed(123)
```

Fix connection issue
```{r}
unregister_dopar <- function() {
  env <- foreach:::.foreachGlobals
  rm(list=ls(name=env), pos=env)
}
unregister_dopar()
```

Run only once
```{r}

for (i in 1:length(all)){

# Combine index variable with data
data <- cbind(all[[i]], group_index)

# Split data into training and test sets
trainIndex <- createDataPartition(data$group_index, p = 0.8, list = FALSE, times = 1)
train <- data[trainIndex, ]
test <- data[-trainIndex, ]

# Define the model
model <- caret::train(group_index ~ ., data = train, method = "rf", trControl = trainControl(method = "cv", number = 5))

# Make predictions on the test set
predictions <- predict(model, newdata = test)



stat[[i]] <- F1_Score(predictions, test$group_index)

# View the F1 score
}

```

Parallelize 100 iterations
```{r}
library(foreach)
library(doParallel)
library(caret)
library(randomForest)

# Set the number of cores to use
num_cores <- 6
cl <- makeCluster(num_cores)
registerDoParallel(cl)
importances = list()
# Set the number of iterations
num_iterations <- 100

# Create a list to store the results
stat <- list()

# Loop over the data
foreach(i = 1:length(all), .combine = c, .packages = c("caret","randomForest")) %dopar% {
  # Combine index variable with data
  data <- cbind(all[[i]], group_index)
  # Create a list to store the results for this iteration
  result <- list()
  
  for (x in 1:num_iterations){
    # Split data into training and test sets
    trainIndex <- caret::createDataPartition(data$group_index, p = 0.8, list = FALSE, times = 1)
    train <- data[trainIndex, ]
    test <- data[-trainIndex, ]

    # Define the model
    model <- caret::train(group_index ~ ., data = train, method = "rf", trControl = trainControl(method = "cv", number = 5))
    
    # Make predictions on the test set
    predictions <- predict(model, newdata = test)

    # Store the result for this iteration
    importances[[x]] <- varImp(model$finalModel)
    result[[x]] <- F1_Score(predictions, test$group_index)
  }
  # Combine the results for this iteration into the stat list
  names(importances) <- paste(i, seq_along(importances), sep = "_")
  names(result) <- paste(i, seq_along(result), sep = "_")
  list(result, importances)
} -> result_list

# Stop the parallel backend
stopCluster(cl)
registerDoSEQ()
stat = list()
F1 = result_list[seq(1, length(result_list), by = 2)]
# Combine the results into the stat list
for (i in seq_along(F1)) {
  
  stat[[i]] <- do.call("rbind", F1[[i]])
}

#saveRDS(result_list, "./../../results_4ct_sym_0.2grid_self/preference_missspatialLDA_result_list_4ct_cross01.rds")
#see = readRDS("./../../results_4ct_cross01/count_histoCATSEA_result_list_4ct_cross01.rds")

#result_list = readRDS("./../../results_4ct_asym_0.2grid_self/missspatialLDA_result_list_4ct_cross01.rds")

```



Name stats correctly

```{r}

df = as.data.frame.matrix(do.call("rbind", stat))
df$tool = rep(names(all), each = 100)
colnames(df) = c("F1", "FDR", "Run")

# add F1 baseline
#base = as.data.frame.matrix(stat_null)
#base$tool = rep("F1_baseline", 100)
#colnames(base) = c("F1", "FDR", "Run")

# bind baseline and toolresults together
#df = rbind(df, base)
unique(df$Run)

```


Create plot to show comparison
```{r}
# generate dataset

# Get the parts before and after "sim"
df$comparison <- sub(".*(ran|[0-9])_ab", "ab", df$Run)
# this is the comaprison without abundance: df$comparison <- sub(".*_ab._[0-9]\\.[0-9]*_", "", names(all)), just took me long and I did not want to delete it
df$tool <- sub("_(ran|self).*_ab.*", "", df$Run)

```

```{r, fig.height=12, fig.width=12}
unique(df$organization)
df$organization = sub("_ab0.*vs.*$", "", df$Run)
df$organization = sub("^.*self", "self", df$organization)
df$organization = sub("^.*ran", "ran", df$organization)
  
```

Create boxplot as Denis wanted it
```{r, fig.width=30, fig.height = 7}

df$tool = sub("SEA_bi_100iter_direction_delaunay", "SEA_bi_direction_delaunay", df$tool)
df$tool = sub("IMCR_histoCAT_delaunay_p_lt", "IMCR_histoCAT_delaunay", df$tool)

df = df %>% filter(comparison %in% unique(df$comparison)[1:4])


pdf("./../../results_4ct_sym_0.2grid_self/plots/preference_sym_self00_comparison_abundance_boxplots_missing_SpatialLDA.pdf", width = 24, height = 5.5)
ggplot(df, aes(x = factor(comparison), y = F1, color = organization, group = interaction(organization, comparison))) +
  geom_boxplot() +
  facet_grid(. ~ tool) +
  theme_test()  +
  theme(axis.text.x = element_text(size = 9, angle = 90, vjust = 0.5, hjust = 1)) +
  xlab("Abundance comparison") +
  ylab("F1 score (random forest)") +
  #scale_x_discrete(labels=c('0.12 - 0.18', '0.15 - 0.20', '0.17 - 0.22', '0.22 - 0.23', '0.25')) +
  scale_color_discrete(name = "Cohort comparison") #+
  #scale_colour_brewer(palette = "Dark2")
dev.off()

```

